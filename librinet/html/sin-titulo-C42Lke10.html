<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Serial a Google Sheets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center p-6">

    <div class="w-full max-w-2xl bg-gray-800 rounded-3xl shadow-2xl overflow-hidden border border-gray-700">
        <!-- Encabezado -->
        <div class="bg-gray-700 p-6 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-white">Monitor Serial Arduino</h1>
                <p class="text-sm text-gray-400">DHT-11 a Google Sheets</p>
            </div>
            <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1 rounded-full bg-red-900/30 border border-red-500 text-red-400 text-xs font-medium">
                <span class="w-2 h-2 rounded-full bg-red-500"></span>
                Desconectado
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="p-8 space-y-8">
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="connectBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 px-6 rounded-xl transition-all transform active:scale-95 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Abrir Puerto Serie
                </button>
                <button id="disconnectBtn" class="hidden flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-xl transition-all flex items-center justify-center gap-2">
                    Detener
                </button>
            </div>

            <!-- Visualización de Datos -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-900/50 p-6 rounded-2xl border border-gray-700 text-center">
                    <p class="text-gray-400 text-sm mb-1 uppercase tracking-wider">Temperatura</p>
                    <div id="tempVal" class="text-5xl font-black text-orange-500">--</div>
                    <p class="text-xs text-gray-500 mt-2">Columna B</p>
                </div>
                <div class="bg-gray-900/50 p-6 rounded-2xl border border-gray-700 text-center">
                    <p class="text-gray-400 text-sm mb-1 uppercase tracking-wider">Humedad</p>
                    <div id="humVal" class="text-5xl font-black text-blue-400">--</div>
                    <p class="text-xs text-gray-500 mt-2">Columna C</p>
                </div>
            </div>

            <!-- Log de Actividad -->
            <div class="space-y-2">
                <p class="text-xs font-semibold text-gray-500 uppercase ml-1">Log de Sincronización</p>
                <div id="terminal" class="bg-black p-4 rounded-xl h-48 overflow-y-auto font-mono text-xs text-green-400 border border-gray-700">
                    > Inicie la conexión para comenzar...
                </div>
            </div>
        </div>

        <div class="bg-gray-900/80 p-4 border-t border-gray-700 text-center text-[10px] text-gray-500">
            Formato: DD/MM/YYYY HH:MM:SS | Sincronización Activa
        </div>
    </div>

    <script>
        // URL de Apps Script proporcionada
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz1GTIpQQ0mGahHR92vQkf48fMEbYntZ63fWy_6JLsBZ5m1v-JU8l5qpmF1uX31eYCZ/exec"; 

        let port, reader;
        let keepReading = true;
        let currentTemp = null;
        let currentHum = null;

        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const terminal = document.getElementById('terminal');
        const statusEl = document.getElementById('connectionStatus');

        function log(msg, type = 'info') {
            const colors = { info: 'text-green-400', error: 'text-red-400', sync: 'text-blue-400' };
            const time = new Date().toLocaleTimeString();
            terminal.innerHTML += `<div class="${colors[type]}"><span class="opacity-50">[${time}]</span> ${msg}</div>`;
            terminal.scrollTop = terminal.scrollHeight;
        }

        function getFormattedDate() {
            const now = new Date();
            const d = n => n.toString().padStart(2, '0');
            // Formato pedido: 11/01/2026 21:48:00
            return `${d(now.getDate())}/${d(now.getMonth() + 1)}/${now.getFullYear()} ${d(now.getHours())}:${d(now.getMinutes())}:${d(now.getSeconds())}`;
        }

        async function sendToGoogleSheets(temp, hum) {
            const payload = {
                fecha: getFormattedDate(),
                temperatura: temp,
                humedad: hum
            };

            try {
                // Usamos fetch con mode: 'no-cors' para Apps Script
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                log(`Sincronizado en Sheets: T:${temp} H:${hum}`, 'sync');
            } catch (e) {
                log("Error de envío: " + e.message, 'error');
            }
        }

        async function connectSerial() {
            if (!("serial" in navigator)) {
                log("Su navegador no soporta Serial API (Use Chrome)", 'error');
                return;
            }
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 status-pulse"></span> Conectado';
                statusEl.className = "flex items-center gap-2 px-3 py-1 rounded-full bg-green-900/30 border border-green-500 text-green-400 text-xs font-medium";
                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
                log("Puerto abierto.");
                readStream();
            } catch (e) { log("Error: " + e.message, 'error'); }
        }

        async function readStream() {
            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();
            let lineBuffer = "";

            try {
                while (keepReading) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    lineBuffer += value;
                    if (lineBuffer.includes('\n')) {
                        const lines = lineBuffer.split('\n');
                        lineBuffer = lines.pop();
                        for (const line of lines) {
                            const cleanLine = line.trim();
                            if (!cleanLine) continue;
                            
                            // Detección por etiquetas (Formato Arduino Bloques)
                            if (cleanLine.includes("TEMPERATURA:")) {
                                currentTemp = cleanLine.split(":")[1].trim();
                                document.getElementById('tempVal').innerText = currentTemp + "°";
                            } else if (cleanLine.includes("HUMEDAD:")) {
                                currentHum = cleanLine.split(":")[1].trim();
                                document.getElementById('humVal').innerText = currentHum + "%";
                            }

                            if (currentTemp && currentHum) {
                                await sendToGoogleSheets(currentTemp, currentHum);
                                currentTemp = null; 
                                currentHum = null;
                            }
                        }
                    }
                }
            } catch (e) { log("Error de lectura: " + e.message, 'error'); }
        }

        connectBtn.addEventListener('click', connectSerial);
        disconnectBtn.addEventListener('click', () => location.reload());
    </script>
</body>
</html>