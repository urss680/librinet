<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Serial - Actualización cada 1 min</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .data-refresh {
            animation: flash 0.8s ease-out;
        }
        @keyframes flash {
            0% { background-color: rgba(59, 130, 246, 0.3); }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center p-6">

    <div class="w-full max-w-2xl bg-gray-800 rounded-3xl shadow-2xl overflow-hidden border border-gray-700">
        <!-- Encabezado -->
        <div class="bg-gray-700 p-6 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-white">Monitor Serial Arduino</h1>
                <p class="text-sm text-gray-400">Refresco de pantalla: 1 minuto</p>
            </div>
            <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1 rounded-full bg-red-900/30 border border-red-500 text-red-400 text-xs font-medium">
                <span class="w-2 h-2 rounded-full bg-red-500"></span>
                Desconectado
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="p-8 space-y-8">
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="connectBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 px-6 rounded-xl transition-all transform active:scale-95 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Abrir Puerto Serie
                </button>
                <button id="disconnectBtn" class="hidden flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-xl transition-all flex items-center justify-center gap-2">
                    Cerrar
                </button>
            </div>

            <!-- Temporizador visual -->
            <div class="w-full bg-gray-900 rounded-full h-1.5 mb-2 overflow-hidden">
                <div id="progressBar" class="bg-blue-500 h-full w-0 transition-all duration-1000"></div>
            </div>
            <p id="nextUpdateTxt" class="text-center text-[10px] text-gray-500 uppercase tracking-widest">Próxima actualización en: 60s</p>

            <!-- Visualización de Datos -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div id="tempContainer" class="bg-gray-900/50 p-6 rounded-2xl border border-gray-700 text-center transition-all">
                    <p class="text-gray-400 text-sm mb-1 uppercase tracking-wider">Temperatura</p>
                    <div id="tempVal" class="text-5xl font-black text-orange-500">--</div>
                    <p class="text-xs text-gray-500 mt-2">Valor cada 1 min</p>
                </div>
                <div id="humContainer" class="bg-gray-900/50 p-6 rounded-2xl border border-gray-700 text-center transition-all">
                    <p class="text-gray-400 text-sm mb-1 uppercase tracking-wider">Humedad</p>
                    <div id="humVal" class="text-5xl font-black text-blue-400">--</div>
                    <p class="text-xs text-gray-500 mt-2">Valor cada 1 min</p>
                </div>
            </div>

            <!-- Log de Actividad -->
            <div class="space-y-2">
                <p class="text-xs font-semibold text-gray-500 uppercase ml-1">Tráfico de Datos (Tiempo Real)</p>
                <div id="terminal" class="bg-black p-4 rounded-xl h-32 overflow-y-auto font-mono text-[10px] text-green-500/70 border border-gray-700">
                    > Conecte su Arduino...
                </div>
            </div>
        </div>

        <div class="bg-gray-900/80 p-4 border-t border-gray-700 text-center text-[10px] text-gray-500">
            Sincronización Sheets habilitada | Ciclo: 60 segundos
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz1GTIpQQ0mGahHR92vQkf48fMEbYntZ63fWy_6JLsBZ5m1v-JU8l5qpmF1uX31eYCZ/exec"; 

        let port, reader;
        let keepReading = true;
        
        // Variables para captura de datos
        let bufferTemp = null;
        let bufferHum = null;
        
        // Variables para el control de tiempo (1 minuto = 60000ms)
        const UPDATE_INTERVAL = 60000; 
        let timeLeft = 60;

        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const terminal = document.getElementById('terminal');
        const statusEl = document.getElementById('connectionStatus');
        const progressBar = document.getElementById('progressBar');
        const nextUpdateTxt = document.getElementById('nextUpdateTxt');
        
        const tempValDisplay = document.getElementById('tempVal');
        const humValDisplay = document.getElementById('humVal');
        const tempContainer = document.getElementById('tempContainer');
        const humContainer = document.getElementById('humContainer');

        function log(msg, type = 'info') {
            const colors = { info: 'text-green-500/70', error: 'text-red-400', sync: 'text-blue-400' };
            const time = new Date().toLocaleTimeString();
            terminal.innerHTML += `<div class="${colors[type]}"><span class="opacity-50">[${time}]</span> ${msg}</div>`;
            terminal.scrollTop = terminal.scrollHeight;
        }

        function getFormattedDate() {
            const now = new Date();
            const d = n => n.toString().padStart(2, '0');
            return `${d(now.getDate())}/${d(now.getMonth() + 1)}/${now.getFullYear()} ${d(now.getHours())}:${d(now.getMinutes())}:${d(now.getSeconds())}`;
        }

        // Esta función actualiza la interfaz visual y envía a Google Sheets
        async function refreshUIAndSync() {
            if (bufferTemp !== null && bufferHum !== null) {
                // Actualizar números en pantalla
                tempValDisplay.innerText = bufferTemp + "°";
                humValDisplay.innerText = bufferHum + "%";
                
                // Efecto visual
                tempContainer.classList.add('data-refresh');
                humContainer.classList.add('data-refresh');
                setTimeout(() => {
                    tempContainer.classList.remove('data-refresh');
                    humContainer.classList.remove('data-refresh');
                }, 800);

                // Enviar a Google Sheets
                await sendToGoogleSheets(bufferTemp, bufferHum);
                
                log(`Sincronización de minuto completada: T:${bufferTemp} H:${bufferHum}`, 'sync');
            } else {
                log("Ciclo cumplido pero no hay datos suficientes del Arduino", 'error');
            }
        }

        async function sendToGoogleSheets(temp, hum) {
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        fecha: getFormattedDate(),
                        temperatura: temp,
                        humedad: hum
                    })
                });
            } catch (e) { log("Error de envío a Google: " + e.message, 'error'); }
        }

        // Reloj de cuenta regresiva
        function startTimer() {
            setInterval(() => {
                if (!port) return;
                
                timeLeft--;
                if (timeLeft < 0) {
                    timeLeft = 60;
                    refreshUIAndSync();
                }
                
                // Actualizar barra y texto
                const percent = ((60 - timeLeft) / 60) * 100;
                progressBar.style.width = percent + "%";
                nextUpdateTxt.innerText = `Próxima actualización en: ${timeLeft}s`;
            }, 1000);
        }

        async function connectSerial() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 status-pulse"></span> Conectado';
                statusEl.className = "flex items-center gap-2 px-3 py-1 rounded-full bg-green-900/30 border border-green-500 text-green-400 text-xs font-medium";
                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
                log("Puerto serie conectado. Capturando datos en buffer...");
                readStream();
            } catch (e) { log("Error: " + e.message, 'error'); }
        }

        async function readStream() {
            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();
            let lineBuffer = "";

            try {
                while (keepReading) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    lineBuffer += value;
                    
                    if (lineBuffer.includes('\n')) {
                        const lines = lineBuffer.split('\n');
                        lineBuffer = lines.pop();
                        
                        for (const line of lines) {
                            const cleanLine = line.trim();
                            if (!cleanLine) continue;
                            
                            // Guardamos los datos en el buffer (no se muestran todavía)
                            if (cleanLine.includes("TEMPERATURA:")) {
                                bufferTemp = cleanLine.split(":")[1].trim();
                            } 
                            else if (cleanLine.includes("HUMEDAD:")) {
                                bufferHum = cleanLine.split(":")[1].trim();
                            }
                        }
                    }
                }
            } catch (e) { log("Error de lectura: " + e.message, 'error'); }
        }

        connectBtn.addEventListener('click', connectSerial);
        disconnectBtn.addEventListener('click', () => location.reload());
        
        // Iniciar el reloj al cargar
        startTimer();
    </script>
</body>
</html>