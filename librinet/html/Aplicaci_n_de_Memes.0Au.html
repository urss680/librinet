```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación de Memes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .tab-button.active { background-color: #4f46e5; color: white; }
        .meme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }
        .meme-card {
            background-color: white;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 150px;
        }
        .meme-card:hover { transform: translateY(-5px); }
        .image-loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .text-overlay {
            position: absolute;
            cursor: move;
            border: 2px dashed transparent;
            padding: 4px;
            min-width: 50px;
            min-height: 20px;
        }
        .text-overlay.selected {
            border-color: #4f46e5;
        }
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #4f46e5;
            border: 1px solid white;
            cursor: nwse-resize;
            bottom: -5px;
            right: -5px;
        }
        .editor-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }
        #canvas-container {
            position: relative;
            display: inline-block;
        }
        .control-panel {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 100%;
            max-width: 300px;
        }
        .control-button {
            width: 100%;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .color-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .color-input-group input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        .color-input-group input[type="text"] {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="p-4 bg-gray-100">
    <div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-blue-500 to-green-500 p-4 rounded-lg">
            <span class="text-red-600">TOOGLIA</span> <span class="text-blue-900">MEME</span>
        </h1>

        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-6 space-x-2">
            <button class="tab-button px-4 py-2 rounded-lg text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 active" data-tab="popular-memes">Memes</button>
            <button class="tab-button px-4 py-2 rounded-lg text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300" data-tab="editor">Editor</button>
        </div>

        <!-- Application Messages -->
        <div id="app-messages" class="mb-4 p-3 rounded-lg text-sm text-center hidden"></div>

        <!-- Tab Content -->
        <div id="popular-memes" class="tab-content">
            <div id="meme-list" class="meme-grid">
                <!-- Memes will be loaded here -->
            </div>
        </div>

        <div id="editor" class="tab-content hidden">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Canvas -->
                <div class="flex-1 flex flex-col items-center">
                    <div id="canvas-container" class="editor-container">
                        <img id="meme-image" class="max-w-full h-auto" style="max-height: 500px;" />
                        <!-- Text overlays will be added here -->
                    </div>
                </div>

                <!-- Control Panel -->
                <div class="control-panel">
                    <h3 class="text-lg font-semibold mb-4">Controles</h3>
                    
                    <button id="add-image-btn" class="control-button bg-blue-500 text-white hover:bg-blue-600">Añadir Imagen</button>
                    <button id="add-text-btn" class="control-button bg-green-500 text-white hover:bg-green-600">Añadir Texto</button>
                    <button id="delete-selected-btn" class="control-button bg-red-500 text-white hover:bg-red-600" disabled>Eliminar Seleccionado</button>
                    <button id="download-btn" class="control-button bg-purple-500 text-white hover:bg-purple-600">Descargar</button>
                    
                    <input type="file" id="image-input" accept="image/*" style="display: none;" />
                </div>
            </div>

            <!-- Text Controls -->
            <div id="text-controls" class="hidden mt-6">
                <div class="control-panel mx-auto">
                    <h3 class="text-lg font-semibold mb-4">Controles de Texto</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Texto</label>
                            <input type="text" id="text-content" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese el texto">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tamaño</label>
                            <input type="range" id="text-size" min="10" max="100" value="30" class="w-full">
                            <span id="text-size-value" class="text-sm text-gray-600">30px</span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Color de Letra</label>
                            <div class="color-input-group">
                                <input type="color" id="text-color" value="#ffffff">
                                <input type="text" id="text-color-hex" value="#ffffff" placeholder="#ffffff">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Color de Relleno</label>
                            <div class="color-input-group">
                                <input type="color" id="text-bg-color" value="#000000">
                                <input type="text" id="text-bg-color-hex" value="#000000" placeholder="#000000">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ancho de Borde</label>
                            <input type="range" id="text-stroke-width" min="0" max="10" value="3" class="w-full">
                            <span id="text-stroke-width-value" class="text-sm text-gray-600">3px</span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Color de Borde</label>
                            <div class="color-input-group">
                                <input type="color" id="text-stroke-color" value="#000000">
                                <input type="text" id="text-stroke-color-hex" value="#000000" placeholder="#000000">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fuente</label>
                            <select id="text-font" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="Arial">Arial</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Impact">Impact</option>
                                <option value="Comic Sans MS">Comic Sans MS</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Alineación</label>
                            <div class="flex gap-2">
                                <button class="align-btn px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" data-align="left">Izq</button>
                                <button class="align-btn px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" data-align="center">Cent</button>
                                <button class="align-btn px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" data-align="right">Der</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Opacidad</label>
                            <input type="range" id="text-opacity" min="0" max="1" step="0.1" value="1" class="w-full">
                            <span id="text-opacity-value" class="text-sm text-gray-600">100%</span>
                        </div>
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="text-bold" class="mr-2"> Negrita
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="text-italic" class="mr-2"> Cursiva
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allMemes = [];
        let selectedTextElement = null;
        let isDragging = false;
        let isResizing = false;
        let dragStartX, dragStartY, elementStartX, elementStartY;

        // DOM elements
        const appMessages = document.getElementById('app-messages');
        const memeListDiv = document.getElementById('meme-list');
        const memeImage = document.getElementById('meme-image');
        const canvasContainer = document.getElementById('canvas-container');
        const textControls = document.getElementById('text-controls');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');

        // Function to display application messages
        function showMessage(message, type = 'info') {
            appMessages.textContent = message;
            appMessages.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            if (type === 'error') {
                appMessages.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                appMessages.classList.add('bg-green-100', 'text-green-700');
            } else {
                appMessages.classList.add('bg-blue-100', 'text-blue-700');
            }
            appMessages.classList.remove('hidden');
        }

        // Function to hide messages
        function hideMessage() {
            appMessages.classList.add('hidden');
        }

        // Function to switch tabs
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId).classList.remove('hidden');
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            hideMessage();
        }

        // Event listeners for tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Function to render memes in list
        async function renderMemes(memes, containerElement) {
            containerElement.innerHTML = '';
            if (!memes || memes.length === 0) {
                containerElement.innerHTML = '<p class="text-gray-500">No se encontraron memes.</p>';
                return;
            }

            for (const meme of memes) {
                const memeCard = document.createElement('div');
                memeCard.className = 'meme-card p-2';

                const img = document.createElement('img');
                img.alt = meme.name;
                img.className = 'w-full h-32 object-contain rounded-md mb-2 hidden';
                img.onerror = function() {
                    this.onerror=null;
                    this.src='https://placehold.co/180x128/e0e0e0/555555?text=Imagen+no+disponible';
                    this.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                };

                const loadingSpinner = document.createElement('div');
                loadingSpinner.className = 'image-loading-spinner';

                const name = document.createElement('p');
                name.className = 'text-center text-sm font-medium text-gray-800 truncate mt-auto';

                memeCard.appendChild(loadingSpinner);
                memeCard.appendChild(img);
                memeCard.appendChild(name);
                containerElement.appendChild(memeCard);

                memeCard.addEventListener('click', () => {
                    memeImage.src = meme.url;
                    memeImage.dataset.id = meme.id;
                    canvasContainer.innerHTML = '';
                    canvasContainer.appendChild(memeImage);
                    switchTab('editor');
                });

                try {
                    const response = await fetch(meme.url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const blob = await response.blob();
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        img.src = reader.result;
                        img.classList.remove('hidden');
                        loadingSpinner.classList.add('hidden');
                        name.textContent = meme.name;
                    };
                    reader.readAsDataURL(blob);
                } catch (error) {
                    console.error(`Error al cargar la imagen ${meme.url}:`, error);
                    img.src='https://placehold.co/180x128/e0e0e0/555555?text=Error+al+cargar';
                    img.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    name.textContent = meme.name;
                }
            }
        }

        // Function to get popular memes
        async function getPopularMemes() {
            hideMessage();
            try {
                const response = await fetch('https://api.imgflip.com/get_memes');
                const data = await response.json();

                if (data.success) {
                    allMemes = data.data.memes;
                    renderMemes(allMemes, memeListDiv);
                } else {
                    showMessage(`Error al obtener memes: ${data.error_message || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                console.error('Error fetching memes:', error);
                showMessage('Error de red al intentar obtener memes. Inténtalo de nuevo.', 'error');
            }
        }

        // Text overlay functions
        function createTextOverlay(text = 'Texto') {
            const overlay = document.createElement('div');
            overlay.className = 'text-overlay';
            overlay.contentEditable = true;
            overlay.textContent = text;
            overlay.style.left = '50px';
            overlay.style.top = '50px';
            overlay.style.fontSize = '30px';
            overlay.style.color = '#ffffff';
            overlay.style.fontFamily = 'Arial';
            overlay.style.fontWeight = 'bold';
            overlay.style.textAlign = 'center';
            overlay.style.textShadow = '2px 2px 4px rgba(0,0,0,0.8)';
            overlay.style.backgroundColor = 'transparent';
            overlay.style.webkitTextStroke = '3px #000000';
            
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            overlay.appendChild(resizeHandle);

            canvasContainer.appendChild(overlay);
            selectTextElement(overlay);

            // Event listeners
            overlay.addEventListener('mousedown', startDrag);
            overlay.addEventListener('touchstart', startDrag);
            resizeHandle.addEventListener('mousedown', startResize);
            overlay.addEventListener('click', (e) => {
                e.stopPropagation();
                selectTextElement(overlay);
            });

            return overlay;
        }

        function selectTextElement(element) {
            document.querySelectorAll('.text-overlay').forEach(el => {
                el.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedTextElement = element;
            textControls.classList.remove('hidden');
            deleteSelectedBtn.disabled = false;
            updateTextControls();
        }

        function updateTextControls() {
            if (!selectedTextElement) return;

            document.getElementById('text-content').value = selectedTextElement.textContent;
            document.getElementById('text-size').value = parseInt(selectedTextElement.style.fontSize);
            document.getElementById('text-size-value').textContent = selectedTextElement.style.fontSize;
            document.getElementById('text-color').value = rgbToHex(selectedTextElement.style.color);
            document.getElementById('text-color-hex').value = rgbToHex(selectedTextElement.style.color);
            
            // Background color
            const bgColor = selectedTextElement.style.backgroundColor;
            if (bgColor && bgColor !== 'transparent') {
                document.getElementById('text-bg-color').value = rgbToHex(bgColor);
                document.getElementById('text-bg-color-hex').value = rgbToHex(bgColor);
            } else {
                document.getElementById('text-bg-color').value = '#000000';
                document.getElementById('text-bg-color-hex').value = '#000000';
            }
            
            // Stroke width and color
            const stroke = selectedTextElement.style.webkitTextStroke;
            if (stroke) {
                const parts = stroke.split(' ');
                document.getElementById('text-stroke-width').value = parseInt(parts[0]);
                document.getElementById('text-stroke-width-value').textContent = parts[0];
                document.getElementById('text-stroke-color').value = rgbToHex(parts[1]);
                document.getElementById('text-stroke-color-hex').value = rgbToHex(parts[1]);
            }
            
            document.getElementById('text-font').value = selectedTextElement.style.fontFamily;
            document.getElementById('text-opacity').value = selectedTextElement.style.opacity || '1';
            document.getElementById('text-opacity-value').textContent = Math.round((selectedTextElement.style.opacity || 1) * 100) + '%';
        }

        function rgbToHex(rgb) {
            if (!rgb || rgb.startsWith('#')) return rgb;
            const result = rgb.match(/\d+/g);
            if (!result) return '#ffffff';
            return '#' + ((1 << 24) + (parseInt(result[0]) << 16) + (parseInt(result[1]) << 8) + parseInt(result[2])).toString(16).slice(1);
        }

        function startDrag(e) {
            if (e.target.classList.contains('resize-handle')) return;
            isDragging = true;
            const touch = e.touches ? e.touches[0] : e;
            dragStartX = touch.clientX;
            dragStartY = touch.clientY;
            elementStartX = e.currentTarget.offsetLeft;
            elementStartY = e.currentTarget.offsetTop;
            selectTextElement(e.currentTarget);
            e.preventDefault();
        }

        function startResize(e) {
            isResizing = true;
            e.stopPropagation();
            e.preventDefault();
        }

        document.addEventListener('mousemove', (e) => {
            if (isDragging && selectedTextElement) {
                const dx = e.clientX - dragStartX;
                const dy = e.clientY - dragStartY;
                selectedTextElement.style.left = (elementStartX + dx) + 'px';
                selectedTextElement.style.top = (elementStartY + dy) + 'px';
            }
            if (isResizing && selectedTextElement) {
                const rect = selectedTextElement.getBoundingClientRect();
                const width = e.clientX - rect.left;
                const height = e.clientY - rect.top;
                selectedTextElement.style.width = Math.max(50, width) + 'px';
                selectedTextElement.style.height = Math.max(20, height) + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            isResizing = false;
        });

        document.addEventListener('touchmove', (e) => {
            if (isDragging && selectedTextElement) {
                const touch = e.touches[0];
                const dx = touch.clientX - dragStartX;
                const dy = touch.clientY - dragStartY;
                selectedTextElement.style.left = (elementStartX + dx) + 'px';
                selectedTextElement.style.top = (elementStartY + dy) + 'px';
            }
        });

        document.addEventListener('touchend', () => {
            isDragging = false;
            isResizing = false;
        });

        canvasContainer.addEventListener('click', (e) => {
            if (e.target === canvasContainer || e.target === memeImage) {
                document.querySelectorAll('.text-overlay').forEach(el => {
                    el.classList.remove('selected');
                });
                selectedTextElement = null;
                textControls.classList.add('hidden');
                deleteSelectedBtn.disabled = true;
            }
        });

        // Text controls event listeners
        document.getElementById('text-content').addEventListener('input', (e) => {
            if (selectedTextElement) {
                selectedTextElement.textContent = e.target.value;
            }
        });

        document.getElementById('text-size').addEventListener('input', (e) => {
            if (selectedTextElement) {
                selectedTextElement.style.fontSize = e.target.value + 'px';
                document.getElementById('text-size-value').textContent = e.target.value + 'px';
            }
        });

        document.getElementById('text-color').addEventListener('input', (e) => {
            if (selectedTextElement) {
                selectedTextElement.style.color = e.target.value;
                document.getElementById('text-color-hex').value = e.target.value;
            }
        });

        document.getElementById('text-color-hex').addEventListener('input', (e) => {
            if (selectedTextElement && /^#[0-9A-F]{6}$/i.test(e.target.value)) {
                selectedTextElement.style.color = e.target.value;
                document.getElementById('text-color').value = e.target.value;
            }
        });

        document.getElementById('text-bg-color').addEventListener('input', (e) => {
            if (selectedTextElement) {
                selectedTextElement.style.backgroundColor = e.target.value;
                document.getElementById('text-bg-color-hex').value = e.target.value;
            }
        });

        document.getElementById('text-bg-color-hex').addEventListener('input', (e) => {
            if (selectedTextElement && /^#[0-9A-F]{6}$/i.test(e.target.value)) {
                selectedTextElement.style.backgroundColor = e.target.value;
                document.getElementById('text-bg-color').value = e.target.value;
            }
        });

        document.getElementById('text-stroke-width').addEventListener('input', (e) => {
            if (selectedTextElement) {
                const strokeColor = document.getElementById('text-stroke-color').value;
                selectedTextElement.style.webkitTextStroke = e.target.value + 'px ' + strokeColor;
                document.getElementById('text-stroke-width-value').textContent = e.target.value + 'px';
            }
        });

        document.getElementById('text-stroke-color').addEventListener('input', (e) => {
            if (selectedTextElement) {
                const strokeWidth = document.getElementById('text-stroke-width').value;
                selectedTextElement.style.webkitTextStroke = strokeWidth + 'px ' + e.target.value;
                document.getElementById('text-stroke-color-hex').value = e.target.value;
            }
        });

        document.getElementById('text-stroke-color-hex').addEventListener('input', (e) => {
            if (selectedTextElement && /^#[0-9A-F]{6}$/i.test(e.target.value)) {
                const strokeWidth = document.getElementById('text-stroke-width').value;
                selectedTextElement.style.webkitTextStroke = strokeWidth + 'px ' + e.target.value;
                document.getElementById('text-stroke-color').value = e.target.value;
            }
        });

        document.getElementById('text-font').addEventListener('change', (e) => {
            if (selectedTextElement) {
                selectedTextElement.style.fontFamily = e.target.value;
            }
        });

        document.getElementById('text-opacity').addEventListener('input', (e) => {
            if (selectedTextElement) {
                selectedTextElement.style.opacity = e.target.value;
                document.getElementById('text-opacity-value').textContent = Math.round(e.target.value * 100) + '%';
            }
        });

        document.getElementById('text-bold').addEventListener('change', (e) => {
            if (selectedTextElement) {
                selectedTextElement.style.fontWeight = e.target.checked ? 'bold' : 'normal';
            }
        });

        document.getElementById('text-italic').addEventListener('change', (e) => {
            if (selectedTextElement) {
                selectedTextElement.style.fontStyle = e.target.checked ? 'italic' : 'normal';
            }
        });

        document.querySelectorAll('.align-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (selectedTextElement) {
                    selectedTextElement.style.textAlign = e.target.dataset.align;
                }
            });
        });

        // Button event listeners
        document.getElementById('add-image-btn').addEventListener('click', () => {
            document.getElementById('image-input').click();
        });

        document.getElementById('image-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.maxWidth = '200px';
                    img.style.position = 'absolute';
                    img.style.left = '50px';
                    img.style.top = '50px';
                    img.style.cursor = 'move';
                    canvasContainer.appendChild(img);
                    
                    // Make draggable
                    let isDraggingImg = false;
                    let startX, startY, initialX, initialY;
                    
                    img.addEventListener('mousedown', (e) => {
                        isDraggingImg = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        initialX = img.offsetLeft;
                        initialY = img.offsetTop;
                    });
                    
                    document.addEventListener('mousemove', (e) => {
                        if (isDraggingImg) {
                            const dx = e.clientX - startX;
                            const dy = e.clientY - startY;
                            img.style.left = (initialX + dx) + 'px';
                            img.style.top = (initialY + dy) + 'px';
                        }
                    });
                    
                    document.addEventListener('mouseup', () => {
                        isDraggingImg = false;
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('add-text-btn').addEventListener('click', () => {
            createTextOverlay();
        });

        document.getElementById('delete-selected-btn').addEventListener('click', () => {
            if (selectedTextElement) {
                selectedTextElement.remove();
                selectedTextElement = null;
                textControls.classList.add('hidden');
                deleteSelectedBtn.disabled = true;
            }
        });

        document.getElementById('download-btn').addEventListener('click', () => {
            // Ocultar todos los elementos de control antes de la captura
            document.querySelectorAll('.text-overlay').forEach(el => {
                el.classList.remove('selected');
                const handle = el.querySelector('.resize-handle');
                if (handle) handle.style.display = 'none';
            });

            // Deseleccionar cualquier texto
            if (document.activeElement && document.activeElement.blur) {
                document.activeElement.blur();
            }

            // Pequeño retraso para asegurar que los cambios se apliquen
            setTimeout(() => {
                html2canvas(canvasContainer).then(canvas => {
                    // Restaurar visibilidad de los handles
                    document.querySelectorAll('.resize-handle').forEach(handle => {
                        handle.style.display = 'block';
                    });

                    const link = document.createElement('a');
                    link.download = 'meme.png';
                    link.href = canvas.toDataURL();
                    link.click();
                }).catch(err => {
                    // Restaurar visibilidad de los handles en caso de error
                    document.querySelectorAll('.resize-handle').forEach(handle => {
                        handle.style.display = 'block';
                    });
                    console.error('Error al generar la imagen:', err);
                });
            }, 50);
        });

        // Initialize the application: load popular memes on start
        window.onload = () => {
            getPopularMemes();
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
```