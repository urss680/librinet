<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor de Texto</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      height: 100%;
    }
    
    html {
      height: 100%;
    }
    
    .editor-content {
      min-height: 300px;
      outline: none;
    }
    
    .editor-content:empty:before {
      content: attr(data-placeholder);
      color: #9ca3af;
    }
    
    .toolbar-button {
      transition: all 0.2s;
    }
    
    .toolbar-button:hover {
      background-color: #f3f4f6;
    }
    
    .toolbar-button.active {
      background-color: #e5e7eb;
    }
    
    .title-input {
      border: none;
      outline: none;
      background: transparent;
      font-size: 1.125rem;
      font-weight: 500;
      width: 100%;
    }
    
    .title-input:focus {
      outline: none;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div id="app" class="h-full flex flex-col"></div>
  <script>
    const defaultConfig = {
      background_color: "#ffffff",
      toolbar_color: "#f9fafb",
      text_color: "#1f2937",
      button_hover_color: "#f3f4f6",
      accent_color: "#3b82f6",
      placeholder_text: "Escribe algo aquí...",
      font_family: "Inter",
      font_size: 16
    };

    let currentDocument = null;
    let allDocuments = [];
    let saveTimeout = null;

    const dataHandler = {
      onDataChanged(data) {
        allDocuments = data;
        
        if (currentDocument && data.length > 0) {
          const updated = data.find(doc => doc.id === currentDocument.id);
          if (updated) {
            currentDocument = updated;
          }
        } else if (data.length > 0 && !currentDocument) {
          currentDocument = data[0];
          renderEditor();
        }
      }
    };

    async function initApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error("Error al inicializar SDK");
        return;
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            const app = document.getElementById('app');
            app.style.backgroundColor = config.background_color || defaultConfig.background_color;
            
            const toolbar = document.querySelector('.toolbar');
            if (toolbar) {
              toolbar.style.backgroundColor = config.toolbar_color || defaultConfig.toolbar_color;
            }
            
            const editor = document.querySelector('.editor-content');
            if (editor) {
              editor.style.color = config.text_color || defaultConfig.text_color;
              const customFont = config.font_family || defaultConfig.font_family;
              const baseFontStack = 'Inter, sans-serif';
              editor.style.fontFamily = `${customFont}, ${baseFontStack}`;
              const baseSize = config.font_size || defaultConfig.font_size;
              editor.style.fontSize = `${baseSize}px`;
              editor.setAttribute('data-placeholder', config.placeholder_text || defaultConfig.placeholder_text);
            }
            
            const titleInput = document.querySelector('.title-input');
            if (titleInput) {
              titleInput.style.color = config.text_color || defaultConfig.text_color;
              const customFont = config.font_family || defaultConfig.font_family;
              const baseFontStack = 'Inter, sans-serif';
              titleInput.style.fontFamily = `${customFont}, ${baseFontStack}`;
              const baseSize = config.font_size || defaultConfig.font_size;
              titleInput.style.fontSize = `${baseSize * 1.125}px`;
            }
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  window.elementSdk.config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.toolbar_color || defaultConfig.toolbar_color,
                set: (value) => {
                  window.elementSdk.config.toolbar_color = value;
                  window.elementSdk.setConfig({ toolbar_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  window.elementSdk.config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.accent_color || defaultConfig.accent_color,
                set: (value) => {
                  window.elementSdk.config.accent_color = value;
                  window.elementSdk.setConfig({ accent_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                window.elementSdk.config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                window.elementSdk.config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["placeholder_text", config.placeholder_text || defaultConfig.placeholder_text]
          ])
        });
      }

      renderEditor();
    }

    function renderEditor() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const app = document.getElementById('app');
      app.style.backgroundColor = config.background_color || defaultConfig.background_color;
      
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'Inter, sans-serif';
      const baseSize = config.font_size || defaultConfig.font_size;
      
      app.innerHTML = `
        <div class="toolbar flex items-center gap-2 px-6 py-3 border-b border-gray-200" style="background-color: ${config.toolbar_color || defaultConfig.toolbar_color}">
          <input 
            type="text" 
            class="title-input" 
            placeholder="Documento sin título"
            value="${currentDocument ? currentDocument.title : ''}"
            style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px;"
          >
        </div>
        
        <div class="toolbar flex items-center gap-1 px-6 py-2 border-b border-gray-200" style="background-color: ${config.toolbar_color || defaultConfig.toolbar_color}">
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="undo" title="Deshacer">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 7v6h6"></path>
              <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"></path>
            </svg>
          </button>
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="redo" title="Rehacer">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 7v6h-6"></path>
              <path d="M3 17a9 9 0 019-9 9 9 0 016 2.3l3 2.7"></path>
            </svg>
          </button>
          
          <div class="w-px h-6 bg-gray-300 mx-2"></div>
          
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="bold" title="Negrita">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
              <path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
            </svg>
          </button>
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="italic" title="Cursiva">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="4" x2="10" y2="4"></line>
              <line x1="14" y1="20" x2="5" y2="20"></line>
              <line x1="15" y1="4" x2="9" y2="20"></line>
            </svg>
          </button>
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="underline" title="Subrayado">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"></path>
              <line x1="4" y1="21" x2="20" y2="21"></line>
            </svg>
          </button>
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="strikeThrough" title="Tachado">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17.3 4.9c-2.3-.6-4.4-1-6.2-.9-2.7 0-5.3.7-5.3 3.6 0 1.5 1.8 3.3 3.6 3.9h.2m8.2 3.7c.3.4.4.8.4 1.3 0 2.9-2.7 3.6-5.3 3.6-2.3 0-4.7-.3-6.2-.9M4 11.5h16"></path>
            </svg>
          </button>
          
          <div class="w-px h-6 bg-gray-300 mx-2"></div>
          
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="justifyLeft" title="Alinear izquierda">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="17" y1="10" x2="3" y2="10"></line>
              <line x1="21" y1="6" x2="3" y2="6"></line>
              <line x1="21" y1="14" x2="3" y2="14"></line>
              <line x1="17" y1="18" x2="3" y2="18"></line>
            </svg>
          </button>
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="justifyCenter" title="Centrar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="10" x2="6" y2="10"></line>
              <line x1="21" y1="6" x2="3" y2="6"></line>
              <line x1="21" y1="14" x2="3" y2="14"></line>
              <line x1="18" y1="18" x2="6" y2="18"></line>
            </svg>
          </button>
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="justifyRight" title="Alinear derecha">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="21" y1="10" x2="7" y2="10"></line>
              <line x1="21" y1="6" x2="3" y2="6"></line>
              <line x1="21" y1="14" x2="3" y2="14"></line>
              <line x1="21" y1="18" x2="7" y2="18"></line>
            </svg>
          </button>
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="justifyFull" title="Justificar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="21" y1="10" x2="3" y2="10"></line>
              <line x1="21" y1="6" x2="3" y2="6"></line>
              <line x1="21" y1="14" x2="3" y2="14"></line>
              <line x1="21" y1="18" x2="3" y2="18"></line>
            </svg>
          </button>
          
          <div class="w-px h-6 bg-gray-300 mx-2"></div>
          
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="insertUnorderedList" title="Lista con viñetas">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"></line>
              <line x1="8" y1="12" x2="21" y2="12"></line>
              <line x1="8" y1="18" x2="21" y2="18"></line>
              <line x1="3" y1="6" x2="3.01" y2="6"></line>
              <line x1="3" y1="12" x2="3.01" y2="12"></line>
              <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </svg>
          </button>
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="insertOrderedList" title="Lista numerada">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="10" y1="6" x2="21" y2="6"></line>
              <line x1="10" y1="12" x2="21" y2="12"></line>
              <line x1="10" y1="18" x2="21" y2="18"></line>
              <path d="M4 6h1v4"></path>
              <path d="M4 10h2"></path>
              <path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"></path>
            </svg>
          </button>
          
          <div class="w-px h-6 bg-gray-300 mx-2"></div>
          
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="indent" title="Aumentar sangría">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 8 7 12 3 16"></polyline>
              <line x1="21" y1="12" x2="11" y2="12"></line>
              <line x1="21" y1="6" x2="11" y2="6"></line>
              <line x1="21" y1="18" x2="11" y2="18"></line>
            </svg>
          </button>
          <button class="toolbar-button px-3 py-2 rounded hover:bg-gray-100" data-command="outdent" title="Disminuir sangría">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="7 8 3 12 7 16"></polyline>
              <line x1="21" y1="12" x2="11" y2="12"></line>
              <line x1="21" y1="6" x2="11" y2="6"></line>
              <line x1="21" y1="18" x2="11" y2="18"></line>
            </svg>
          </button>
        </div>
        
        <div class="flex-1 overflow-auto px-6 py-8">
          <div 
            class="editor-content max-w-4xl mx-auto"
            contenteditable="true"
            data-placeholder="${config.placeholder_text || defaultConfig.placeholder_text}"
            style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;"
          >${currentDocument ? currentDocument.content : ''}</div>
        </div>
      `;
      
      setupEventListeners();
    }

    function setupEventListeners() {
      const titleInput = document.querySelector('.title-input');
      const editor = document.querySelector('.editor-content');
      const toolbarButtons = document.querySelectorAll('.toolbar-button');
      
      titleInput.addEventListener('input', () => {
        if (currentDocument) {
          currentDocument.title = titleInput.value;
          scheduleAutoSave();
        } else {
          createNewDocument(titleInput.value, '');
        }
      });
      
      editor.addEventListener('input', () => {
        if (currentDocument) {
          currentDocument.content = editor.innerHTML;
          scheduleAutoSave();
        } else {
          createNewDocument('', editor.innerHTML);
        }
      });
      
      toolbarButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          e.preventDefault();
          const command = button.getAttribute('data-command');
          document.execCommand(command, false, null);
          editor.focus();
          updateToolbarState();
        });
      });
      
      editor.addEventListener('mouseup', updateToolbarState);
      editor.addEventListener('keyup', updateToolbarState);
    }

    function updateToolbarState() {
      const commands = ['bold', 'italic', 'underline', 'strikeThrough', 'justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull', 'insertUnorderedList', 'insertOrderedList'];
      
      commands.forEach(command => {
        const button = document.querySelector(`[data-command="${command}"]`);
        if (button) {
          if (document.queryCommandState(command)) {
            button.classList.add('active');
          } else {
            button.classList.remove('active');
          }
        }
      });
    }

    async function createNewDocument(title, content) {
      if (allDocuments.length >= 999) {
        showMessage('Límite alcanzado: máximo 999 documentos. Por favor, elimina algunos primero.');
        return;
      }

      const newDoc = {
        id: Date.now().toString(),
        title: title || 'Documento sin título',
        content: content || '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      currentDocument = newDoc;
      
      const result = await window.dataSdk.create(newDoc);
      if (!result.isOk) {
        showMessage('Error al crear el documento');
      }
    }

    function scheduleAutoSave() {
      if (saveTimeout) {
        clearTimeout(saveTimeout);
      }
      
      saveTimeout = setTimeout(async () => {
        if (currentDocument) {
          currentDocument.updatedAt = new Date().toISOString();
          const result = await window.dataSdk.update(currentDocument);
          if (!result.isOk) {
            showMessage('Error al guardar el documento');
          }
        }
      }, 1000);
    }

    function showMessage(message) {
      const existingToast = document.querySelector('.toast-message');
      if (existingToast) {
        existingToast.remove();
      }
      
      const toast = document.createElement('div');
      toast.className = 'toast-message fixed bottom-6 right-6 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'996c41bf93600331',t:'MTc2MTg0MTQwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>