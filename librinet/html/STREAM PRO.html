<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamShare Social - Studio Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            margin: 0;
            height: 100%;
            background: #0a0a0a;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: #fff;
            overflow: hidden;
        }
        #onboarding {
            position: fixed;
            inset: 0;
            background: #0a0a0a;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        #screenShare {
            width: 100%;
            height: 100%;
            background: #000;
            border: 2px solid #1a1a1a;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .sidebar {
            background: #0f0f0f;
            border-right: 1px solid #222;
        }
        .mode-btn {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #888;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .mode-btn.active {
            border-color: #0ff;
            color: #0ff;
            background: rgba(0, 255, 255, 0.05);
        }
        .action-btn {
            background: #0ff;
            color: #000;
            font-weight: 900;
            padding: 10px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.3s;
        }
        .action-btn:hover:not(:disabled) {
            background: #00cccc;
            transform: translateY(-1px);
        }
        .reaction-bubble {
            position: absolute;
            bottom: 20px;
            font-size: 2rem;
            pointer-events: none;
            z-index: 50;
            animation: floatUp 2s ease-out forwards;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { opacity: 1; transform: translateY(-20px) scale(1.2); }
            100% { transform: translateY(-250px) translateX(20px) scale(1); opacity: 0; }
        }
        .live-tag {
            background: #f00;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen">

    <!-- Pantalla de Inicio -->
    <div id="onboarding">
        <div class="max-w-md w-full p-8 bg-neutral-900 border border-white/10 rounded-2xl shadow-2xl text-center">
            <h1 class="text-4xl font-black text-white tracking-tighter italic mb-2 uppercase">StreamShare <span class="text-cyan-400">Social</span></h1>
            <p class="text-gray-500 text-[10px] mb-8 uppercase tracking-[0.3em]">Conecta y Reacciona</p>
            
            <div class="text-left mb-6">
                <label class="text-[10px] text-gray-400 uppercase font-bold mb-2 block tracking-widest">Tu Identidad</label>
                <input type="text" id="username-input" placeholder="Nombre de usuario..." 
                    class="w-full bg-black border border-neutral-700 rounded-lg p-4 text-white outline-none focus:border-cyan-500 transition-all font-medium">
            </div>

            <button id="enter-btn" class="action-btn w-full py-4 text-lg">Entrar al Sistema</button>
        </div>
    </div>

    <!-- Barra Lateral -->
    <aside class="sidebar w-full md:w-72 flex flex-col p-6 space-y-6">
        <div>
            <h1 class="text-xl font-black text-white italic uppercase tracking-tighter">Studio <span class="text-cyan-400">Pro</span></h1>
            <p id="display-name" class="text-[9px] text-gray-500 font-mono mt-1 uppercase">ID: DESCONECTADO</p>
        </div>

        <div class="space-y-4">
            <div class="space-y-2">
                <label class="text-[9px] text-gray-500 uppercase font-bold tracking-widest block">Fuente de Video</label>
                <div class="grid grid-cols-2 gap-2">
                    <button id="btnModeScreen" class="mode-btn active">Pantalla</button>
                    <button id="btnModeCamera" class="mode-btn">C√°mara</button>
                </div>
            </div>

            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/5">
                <span class="text-[10px] font-bold text-gray-400 uppercase">Micr√≥fono</span>
                <input type="checkbox" id="useMic" checked class="accent-cyan-500 w-4 h-4">
            </div>

            <button id="startBtn" class="action-btn w-full shadow-lg shadow-cyan-500/10">Iniciar Directo</button>
            <button id="stopBtn" class="hidden w-full bg-red-600/20 text-red-500 border border-red-500/50 font-bold p-3 rounded uppercase text-[10px] hover:bg-red-600 hover:text-white transition-all">Detener Se√±al</button>
        </div>

        <div class="flex-1 flex flex-col min-h-0 border-t border-white/5 pt-4">
            <h2 class="text-[9px] text-gray-500 uppercase font-bold mb-3 tracking-widest">Salas Activas</h2>
            <div id="rooms-list" class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                <!-- Salas din√°micas -->
            </div>
        </div>
    </aside>

    <!-- √Årea Principal -->
    <main class="flex-1 p-4 md:p-6 flex flex-col bg-black">
        <div id="screenShare">
            <div id="status-overlay" class="absolute top-4 left-4 z-20"></div>
            <!-- Contenedor de reacciones flotantes -->
            <div id="reaction-container" class="absolute inset-0 pointer-events-none z-40"></div>
            
            <div id="placeholder" class="text-center opacity-10 select-none">
                <div class="text-8xl mb-4 font-black">LIVE</div>
                <p class="font-mono text-[10px] tracking-[0.5em]">WAITING_FOR_SIGNAL</p>
            </div>
        </div>

        <!-- Barra Inferior Social -->
        <div class="mt-4 flex flex-col lg:flex-row gap-4 items-start">
            <!-- Info y Reacciones -->
            <div class="flex-1 w-full">
                <div class="flex items-center justify-between mb-2">
                    <h2 id="viewing-name" class="text-lg font-bold text-white italic truncate">Visualizaci√≥n Libre</h2>
                    <div id="reaction-bar" class="hidden flex items-center gap-2 bg-white/5 p-1 rounded-full border border-white/10">
                        <button class="hover:scale-125 transition-transform px-2 py-1" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                        <button class="hover:scale-125 transition-transform px-2 py-1" onclick="sendReaction('üëç')">üëç</button>
                        <button class="hover:scale-125 transition-transform px-2 py-1" onclick="sendReaction('üî•')">üî•</button>
                        <button class="hover:scale-125 transition-transform px-2 py-1" onclick="sendReaction('üòÆ')">üòÆ</button>
                        <button class="hover:scale-125 transition-transform px-2 py-1" onclick="sendReaction('üòÇ')">üòÇ</button>
                    </div>
                </div>
                <p id="room-info" class="text-[10px] text-gray-600 font-mono uppercase">Estado: Listo para conectar</p>
            </div>

            <!-- Lista de Audiencia Horizontal -->
            <div id="audience-panel" class="hidden w-full lg:w-72 bg-white/5 rounded-xl p-3 border border-white/10">
                <div class="flex items-center justify-between mb-2 px-1">
                    <span class="text-[9px] text-gray-500 font-bold uppercase tracking-widest">En esta sala</span>
                    <span id="viewer-count" class="bg-cyan-500 text-black text-[9px] px-2 py-0.5 rounded-full font-black">0</span>
                </div>
                <div id="viewer-list" class="flex flex-wrap gap-2 max-h-16 overflow-y-auto custom-scrollbar">
                    <!-- Espectadores -->
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, onChildAdded, remove, update, onDisconnect } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.app";

        const firebaseConfig = {
            apiKey: "AIzaSyDuzW2fxNBAbXAajDeYlluI9xp6mlau1w8",
            authDomain: "chat-1e83b.firebaseapp.com",
            databaseURL: "https://chat-1e83b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chat-1e83b",
            storageBucket: "chat-1e83b.firebasestorage.app",
            messagingSenderId: "803748270514",
            appId: "1:803748270514:web:b462c4a53f44e61d6a14ab"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

        // Globals
        let currentUser = "";
        let currentMode = 'screen'; 
        let isBroadcasting = false;
        let mainStream = null;
        let currentRoomId = null;
        let activePeerConnections = new Map();
        let connectedViewers = {}; 

        // UI Refs
        const onboarding = document.getElementById('onboarding');
        const usernameInput = document.getElementById('username-input');
        const enterBtn = document.getElementById('enter-btn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const reactionContainer = document.getElementById('reaction-container');
        const reactionBar = document.getElementById('reaction-bar');
        const viewerList = document.getElementById('viewer-list');
        const audiencePanel = document.getElementById('audience-panel');

        enterBtn.onclick = () => {
            const val = usernameInput.value.trim();
            if (val.length < 2) return;
            currentUser = val;
            document.getElementById('display-name').innerText = `ID: ${currentUser.toUpperCase()}`;
            onboarding.style.display = 'none';
        };

        // Funci√≥n global para enviar reacciones
        window.sendReaction = (emoji) => {
            if (!currentRoomId) return;
            const reactionRef = push(ref(db, `reactions/${currentRoomId}`));
            set(reactionRef, { emoji, timestamp: Date.now() });
        };

        const showReaction = (emoji) => {
            const el = document.createElement('div');
            el.className = 'reaction-bubble';
            el.innerText = emoji;
            el.style.left = (Math.random() * 80 + 10) + '%';
            reactionContainer.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        };

        const updateAudienceUI = () => {
            document.getElementById('viewer-count').innerText = Object.keys(connectedViewers).length;
            viewerList.innerHTML = '';
            Object.values(connectedViewers).forEach(name => {
                const tag = document.createElement('span');
                tag.className = "text-[9px] bg-white/10 px-2 py-1 rounded-md text-gray-300 font-mono flex items-center gap-1";
                tag.innerHTML = `<span class="w-1 h-1 bg-cyan-400 rounded-full animate-pulse"></span>${name}`;
                viewerList.appendChild(tag);
            });
        };

        // L√≥gica de Sala y Transmisi√≥n
        startBtn.onclick = async () => {
            try {
                isBroadcasting = true;
                document.getElementById('placeholder').classList.add('hidden');
                audiencePanel.classList.remove('hidden');
                reactionBar.classList.remove('hidden');
                
                let stream = (currentMode === 'screen') 
                    ? await navigator.mediaDevices.getDisplayMedia({ video: true })
                    : await navigator.mediaDevices.getUserMedia({ video: true });
                
                mainStream = new MediaStream(stream.getVideoTracks());
                if (document.getElementById('useMic').checked) {
                    const audio = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mainStream.addTrack(audio.getAudioTracks()[0]);
                }

                const v = document.createElement('video');
                v.srcObject = mainStream; v.autoplay = true; v.muted = true;
                document.getElementById('screenShare').appendChild(v);
                
                document.getElementById('status-overlay').innerHTML = '<span class="live-tag uppercase">‚óè Transmitiendo</span>';
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');

                const roomRef = push(ref(db, 'rooms'));
                currentRoomId = roomRef.key;
                onDisconnect(ref(db, `rooms/${currentRoomId}`)).remove();
                onDisconnect(ref(db, `calls/${currentRoomId}`)).remove();
                onDisconnect(ref(db, `reactions/${currentRoomId}`)).remove();
                
                await set(roomRef, { host: currentUser, timestamp: Date.now() });

                // Escuchar reacciones
                onChildAdded(ref(db, `reactions/${currentRoomId}`), (snap) => showReaction(snap.val().emoji));

                // Escuchar espectadores
                onChildAdded(ref(db, `calls/${currentRoomId}`), async (snap) => {
                    const data = snap.val();
                    const callId = snap.key;
                    if (data && data.offer) {
                        const pc = new RTCPeerConnection(servers);
                        activePeerConnections.set(callId, pc);
                        connectedViewers[callId] = data.viewerName || "An√≥nimo";
                        updateAudienceUI();
                        mainStream.getTracks().forEach(t => pc.addTrack(t, mainStream));
                        pc.onicecandidate = (e) => e.candidate && push(ref(db, `calls/${currentRoomId}/${callId}/hostCandidates`), e.candidate.toJSON());
                        pc.onconnectionstatechange = () => {
                            if (['disconnected', 'failed', 'closed'].includes(pc.connectionState)) {
                                pc.close(); activePeerConnections.delete(callId);
                                delete connectedViewers[callId]; updateAudienceUI();
                            }
                        };
                        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        await update(ref(db, `calls/${currentRoomId}/${callId}`), { answer: { type: answer.type, sdp: answer.sdp } });
                        onChildAdded(ref(db, `calls/${currentRoomId}/${callId}/clientCandidates`), (s) => pc.addIceCandidate(new RTCIceCandidate(s.val())));
                    }
                });
            } catch (err) { isBroadcasting = false; }
        };

        window.stopBroadcasting = () => {
            if (mainStream) mainStream.getTracks().forEach(t => t.stop());
            if (currentRoomId) {
                remove(ref(db, `rooms/${currentRoomId}`));
                remove(ref(db, `calls/${currentRoomId}`));
                remove(ref(db, `reactions/${currentRoomId}`));
            }
            location.reload();
        };

        stopBtn.onclick = window.stopBroadcasting;

        // Unirse a sala
        window.joinRoom = async (roomId, host) => {
            if (isBroadcasting) return;
            currentRoomId = roomId;
            document.getElementById('screenShare').innerHTML = '<div id="reaction-container" class="absolute inset-0 pointer-events-none z-40"></div><div class="text-[10px] animate-pulse font-mono">CONECTANDO A SALA DE ' + host.toUpperCase() + '...</div>';
            document.getElementById('viewing-name').innerText = `Stream de ${host}`;
            audiencePanel.classList.remove('hidden');
            reactionBar.classList.remove('hidden');

            const pc = new RTCPeerConnection(servers);
            pc.ontrack = (e) => {
                if (document.getElementById('screenShare').querySelector('video')) return;
                document.getElementById('screenShare').innerHTML = '<div id="reaction-container" class="absolute inset-0 pointer-events-none z-40"></div>';
                const v = document.createElement('video');
                v.srcObject = e.streams[0]; v.autoplay = true; v.controls = true;
                document.getElementById('screenShare').appendChild(v);
            };

            const callRef = push(ref(db, `calls/${roomId}`));
            pc.onicecandidate = (e) => e.candidate && push(ref(db, `calls/${roomId}/${callRef.key}/clientCandidates`), e.candidate.toJSON());
            const offer = await pc.createOffer({ offerToReceiveVideo: true, offerToReceiveAudio: true });
            await pc.setLocalDescription(offer);
            await update(callRef, { offer: { type: offer.type, sdp: offer.sdp }, viewerName: currentUser });
            
            onValue(callRef, (snap) => {
                const d = snap.val();
                if (d?.answer && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(d.answer));
            });
            onChildAdded(ref(db, `calls/${roomId}/${callRef.key}/hostCandidates`), (s) => pc.addIceCandidate(new RTCIceCandidate(s.val())));
            onChildAdded(ref(db, `reactions/${roomId}`), (snap) => showReaction(snap.val().emoji));
            onDisconnect(callRef).remove();
        };

        // Lista de Salas
        onValue(ref(db, 'rooms'), (snapshot) => {
            const list = document.getElementById('rooms-list');
            list.innerHTML = '';
            const rooms = snapshot.val();
            if (!rooms) return;
            Object.keys(rooms).forEach(id => {
                const r = rooms[id];
                const card = document.createElement('div');
                card.className = "p-3 rounded-lg bg-white/5 border border-white/5 hover:border-cyan-500/50 cursor-pointer transition-all group";
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-[10px] font-bold text-white uppercase truncate">${r.host}</span>
                        <span class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></span>
                    </div>
                    <div class="text-[8px] text-gray-500 mt-1 uppercase font-mono group-hover:text-cyan-400">Ver Transmisi√≥n ‚Üí</div>
                `;
                card.onclick = () => joinRoom(id, r.host);
                list.appendChild(card);
            });
        });

        // Eventos de botones de modo
        document.getElementById('btnModeScreen').onclick = () => {
            currentMode = 'screen';
            document.getElementById('btnModeScreen').classList.add('active');
            document.getElementById('btnModeCamera').classList.remove('active');
        };
        document.getElementById('btnModeCamera').onclick = () => {
            currentMode = 'camera';
            document.getElementById('btnModeCamera').classList.add('active');
            document.getElementById('btnModeScreen').classList.remove('active');
        };
    </script>
</body>
</html>