<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro Minutal Madrid - ARDUINO</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background-color: #f8fafc; padding: 20px; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); display: inline-block; min-width: 420px; border: 1px solid #e2e8f0; }
        .live-display { font-size: 3.2em; font-weight: bold; margin: 15px 0; padding: 20px; background: #f1f5f9; border-radius: 15px; color: #1e293b; }
        .status-badge { display: inline-block; padding: 6px 15px; border-radius: 20px; font-size: 0.8em; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }
        .active { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .waiting { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .timer-info { font-size: 0.9em; color: #64748b; margin: 10px 0; }
        progress { width: 100%; height: 12px; accent-color: #3b82f6; }
        .history-card { background: #0f172a; color: #f8fafc; padding: 15px; border-radius: 12px; text-align: left; margin-top: 20px; font-size: 0.85em; }
        .history-card strong { color: #38bdf8; display: block; border-bottom: 1px solid #334155; padding-bottom: 5px; margin-bottom: 8px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: bold; background: #3b82f6; color: white; transition: 0.2s; }
        button:hover { background: #2563eb; }
        #console { font-size: 0.8em; margin-top: 15px; color: #94a3b8; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <div id="status" class="status-badge waiting">Puerto Cerrado</div>
    <h2>Log Minutal (Madrid)</h2>
    <p style="font-size: 0.8em; color: #64748b; margin-top: -10px;">Hoja: <strong>ARDUINO</strong> | Intervalo: 60s</p>
    
    <button id="btnConectar">CONECTAR DISPOSITIVO</button>

    <div class="live-display">
        <span id="t">--</span>¬∞C | <span id="h">--</span>%
    </div>

    <div class="timer-info">
        Pr√≥ximo env√≠o en: <span id="segundos">60</span>s
        <progress id="barrita" value="0" max="60000"></progress>
    </div>

    <div id="console">Esperando conexi√≥n serie...</div>

    <div class="history-card">
        <strong>√öltima entrada en Google Sheets:</strong>
        <div id="last_entry">Cargando historial...</div>
    </div>
</div>

<script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbwa11mHkM9jfXzKlcLwuckOzlB_qHRUQiOLGTTqJbH6LQCrDuYL9Nd4XqBgnZGew3P9/exec";
    const TIMEOUT_MS = 60000; // 60 segundos
    let port;
    let ultimaSincronizacion = Date.now();

    window.onload = refreshHistory;

    async function refreshHistory() {
        try {
            const res = await fetch(APP_URL);
            const data = await res.json();
            if (!data.error) {
                document.getElementById('last_entry').innerHTML = 
                    `üïí Hora Madrid: ${data.fecha}<br>üå°Ô∏è Temp: ${data.temp} | üíß Hum: ${data.hum}%`;
            }
        } catch (e) { console.log("Error al consultar Google"); }
    }

    document.getElementById('btnConectar').onclick = async () => {
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            document.getElementById('btnConectar').style.display = "none";
            document.getElementById('status').innerText = "Sistema en L√≠nea";
            document.getElementById('status').className = "status-badge active";
            ultimaSincronizacion = Date.now(); // Reiniciar timer al conectar
            loopLectura();
        } catch (e) { alert("Error al abrir puerto serie"); }
    };

    async function loopLectura() {
        const textDecoder = new TextDecoderStream();
        port.readable.pipeTo(textDecoder.writable);
        const reader = textDecoder.readable.getReader();

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) {
                const t = value.match(/TEMPERATURA:([\d.]+)/);
                const h = value.match(/HUMEDAD:([\d.]+)/);

                if (t && h) {
                    // Actualizar pantalla (tiempo real)
                    document.getElementById('t').innerText = t[1];
                    document.getElementById('h').innerText = h[1];

                    const ahora = Date.now();
                    const transcurrido = ahora - ultimaSincronizacion;
                    
                    // Actualizar UI del timer
                    const faltan = Math.max(0, Math.ceil((TIMEOUT_MS - transcurrido) / 1000));
                    document.getElementById('segundos').innerText = faltan;
                    document.getElementById('barrita').value = transcurrido;

                    // CONTROL DEL TIMEOUT 60s
                    if (transcurrido >= TIMEOUT_MS) {
                        enviarGoogle(t[1], h[1]);
                        ultimaSincronizacion = ahora;
                    }
                }
            }
        }
    }

    async function enviarGoogle(temp, hum) {
        document.getElementById('console').innerText = "üì§ Sincronizando minuto con Madrid...";
        try {
            await fetch(APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ temp: temp, hum: hum })
            });
            document.getElementById('console').innerText = "‚úÖ Guardado en pesta√±a ARDUINO";
            refreshHistory();
        } catch (e) {
            document.getElementById('console').innerText = "‚ùå Error de env√≠o";
        }
    }
</script>
</body>
</html>