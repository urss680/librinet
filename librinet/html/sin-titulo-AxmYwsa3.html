<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Arduino a Sheets</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f0f2f5; padding: 50px; }
        .panel { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: inline-block; }
        #status { font-weight: bold; margin: 20px 0; color: #d9534f; }
        button { background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        button:disabled { background: #6c757d; }
        .data { font-size: 1.5em; color: #333; margin-top: 20px; }
    </style>
</head>
<body>

<div class="panel">
    <h2>Registro Serial a Google Sheets</h2>
    <button id="conectar">CONECTAR PUERTO SERIE</button>
    <div id="status">Estado: Desconectado</div>
    <div class="data" id="lectura">Esperando datos...</div>
</div>

<script>
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwa11mHkM9jfXzKlcLwuckOzlB_qHRUQiOLGTTqJbH6LQCrDuYL9Nd4XqBgnZGew3P9/exec";
    let puerto;
    let lector;

    document.getElementById('conectar').addEventListener('click', async () => {
        try {
            puerto = await navigator.serial.requestPort();
            await puerto.open({ baudRate: 9600 });
            document.getElementById('status').innerText = "Estado: Conectado ✅";
            document.getElementById('status').style.color = "#28a745";
            document.getElementById('conectar').disabled = true;
            leerDatos();
        } catch (e) { console.error(e); }
    });

    async function leerDatos() {
        const decodificador = new TextDecoderStream();
        puerto.readable.pipeTo(decodificador.writable);
        lector = decodificador.readable.getReader();

        while (true) {
            const { value, done } = await lector.read();
            if (done) break;
            if (value) {
                // Extraer valores del formato TEMPERATURA:valor HUMEDAD:valor
                const t = value.match(/TEMPERATURA:([\d.]+)/);
                const h = value.match(/HUMEDAD:([\d.]+)/);

                if (t && h) {
                    document.getElementById('lectura').innerText = `T: ${t[1]}°C | H: ${h[1]}%`;
                    enviarAGoogle(t[1], h[1]);
                }
            }
        }
    }

    async function enviarAGoogle(t, h) {
        fetch(URL_SCRIPT, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ temp: t, hum: h })
        });
    }
</script>
</body>
</html>